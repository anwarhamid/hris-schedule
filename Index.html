<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRIS Rotation Pro - Vue.js Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] { display: none; }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 20; box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1); }
        .overflow-x-auto::-webkit-scrollbar { height: 8px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .bg-disabled { background-color: #f8fafc; cursor: not-allowed !important; opacity: 0.6; }
        .bg-holiday { background-color: #fff1f2 !important; color: #e11d48 !important; }
    </style>
</head>
<body class="bg-slate-50">

<div id="app" v-cloak class="p-2 md:p-6">
    <div class="max-w-7xl mx-auto space-y-6">
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 flex flex-col items-center text-center gap-6">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">HRIS Rotation Pro</h1>
                <p class="text-slate-500 mt-1 font-medium italic">Shift Schedule: Pagi, Middle, Sore & Off</p>
            </div>
            
            <div class="flex bg-slate-100 p-1.5 rounded-2xl w-fit">
                <button @click="view='week'" :class="view==='week' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'" class="px-6 py-2.5 rounded-xl font-semibold transition-all">Weekly</button>
                <button @click="view='month'" :class="view==='month' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'" class="px-6 py-2.5 rounded-xl font-semibold transition-all">Monthly</button>
                <button @click="view='setting'" :class="view==='setting' ? 'bg-white shadow-sm text-emerald-600' : 'text-slate-500'" class="px-6 py-2.5 rounded-xl font-semibold transition-all">Settings</button>
            </div>
        </div>

        <div v-if="view !== 'setting'" class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="px-6 py-5 flex justify-between items-center border-b border-slate-50">
                <button @click="changeMonth(-1)" class="p-2.5 hover:bg-slate-50 rounded-xl border border-slate-100 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="font-bold text-xl text-slate-800 uppercase tracking-widest">{{ monthLabel }}</h2>
                <button @click="changeMonth(1)" class="p-2.5 hover:bg-slate-50 rounded-xl border border-slate-100 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50/50">
                            <th class="p-5 font-bold text-slate-600 uppercase text-[10px] tracking-wider sticky-col border-b">Employee Name</th>
                            <th v-for="d in activeCalendar" :key="d.fullDate" 
                                class="p-4 text-center border-b border-slate-100 min-w-[140px]" 
                                :class="{'bg-holiday': holidays[d.fullDate] || d.dayName === 'Sun'}">
                                <div class="text-[10px] font-bold opacity-50 uppercase">{{ d.dayName }}</div>
                                <div class="text-lg font-black">{{ d.dateNum }}</div>
                                <div v-if="holidays[d.fullDate]" class="text-[9px] leading-tight mt-1 font-bold whitespace-normal max-w-[110px] mx-auto">{{ holidays[d.fullDate] }}</div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="emp in settings.employees" :key="emp.id">
                            <td class="p-5 font-bold text-slate-700 sticky-col border-b border-slate-50">{{ emp.name }}</td>
                            <td v-for="d in activeCalendar" :key="d.fullDate" class="p-2 border-b border-slate-50">
                                <div @click="openModal(emp.id, d.fullDate)"
                                    class="rounded-xl p-2 text-center transition-all border-2 min-h-[60px] flex flex-col justify-center items-center gap-0.5"
                                    :class="[getShiftClass(getShift(emp.id, d.fullDate).type), !isDateAllowed(d.fullDate) ? 'bg-disabled' : 'cursor-pointer']">
                                    <span class="text-[10px] font-black uppercase tracking-tighter opacity-60">
                                        {{ getShift(emp.id, d.fullDate).type !== 'none' ? getShift(emp.id, d.fullDate).type : '' }}
                                    </span>
                                    <span class="text-[11px] font-bold leading-none">{{ getShift(emp.id, d.fullDate).time }}</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-else class="grid md:grid-cols-2 gap-6">
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 space-y-6">
                <h2 class="font-bold text-xl">Employee Management</h2>
                <div class="flex gap-2">
                    <input v-model="newEmployeeName" placeholder="New Employee Name..." class="flex-1 border border-slate-200 rounded-2xl px-4 py-2 outline-none focus:border-blue-500">
                    <button @click="addEmployee" class="bg-blue-600 text-white px-6 py-2 rounded-2xl font-bold">Add</button>
                </div>
                <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                    <div v-for="emp in settings.employees" :key="emp.id" class="p-5 border border-slate-100 rounded-2xl bg-slate-50 relative">
                        <button @click="removeEmployee(emp.id)" class="absolute top-4 right-4 text-red-400">âœ•</button>
                        <p class="font-bold text-lg mb-4 text-slate-800">{{ emp.name }}</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Odd Week</label>
                                <select v-model="emp.rotation.odd" class="w-full border rounded-xl p-2 bg-white mt-1">
                                    <option value="morning">Morning</option>
                                    <option value="middle">Middle</option>
                                    <option value="afternoon">Afternoon</option>
                                    <option value="off">Day Off</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Even Week</label>
                                <select v-model="emp.rotation.even" class="w-full border rounded-xl p-2 bg-white mt-1">
                                    <option value="morning">Morning</option>
                                    <option value="middle">Middle</option>
                                    <option value="afternoon">Afternoon</option>
                                    <option value="off">Day Off</option>
                                </select>
                            </div>
                        </div>
                        <button @click="applyRotation(emp.id)" class="w-full mt-4 bg-white border border-blue-200 text-blue-600 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-blue-600 hover:text-white transition-all shadow-sm">Apply Rotation</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 space-y-6 h-fit">
                <h2 class="font-bold text-xl">Shift Times Setup</h2>
                <div v-for="(s, key) in settings.shifts" :key="key" class="flex items-center gap-4">
                    <span class="w-24 capitalize font-bold text-slate-500">{{ key }}</span>
                    <input v-model="s.time" class="flex-1 border rounded-xl px-4 py-2 font-mono text-sm bg-white focus:border-emerald-500 outline-none">
                </div>
                <button @click="saveSettings" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl mt-4 hover:bg-emerald-700 transition-colors">Save All Settings</button>
            </div>
        </div>
    </div>

    <div v-if="modalShow" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="modalShow=false"></div>
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm relative shadow-2xl space-y-6">
            <h3 class="text-xl font-bold text-center">Change Shift</h3>
            <select v-model="tempShiftType" class="w-full border-2 rounded-2xl p-4 font-bold bg-slate-50 outline-none focus:border-blue-500">
                <option value="morning">Morning (07:00-15:00)</option>
                <option value="middle">Middle (09:00-17:00)</option>
                <option value="afternoon">Afternoon (15:00-23:00)</option>
                <option value="off">Day Off</option>
            </select>
            <div class="flex gap-3">
                <button @click="modalShow=false" class="flex-1 py-4 border rounded-2xl font-bold">Cancel</button>
                <button @click="saveShiftUpdate" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAT1qgBhA-orooFi1pPcLKvzVqaa0S1hbo",
        authDomain: "hris-schedule.firebaseapp.com",
        databaseURL: "https://hris-schedule-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "hris-schedule",
    };

    const appFirebase = initializeApp(firebaseConfig);
    const db = getDatabase(appFirebase);

    const { createApp, ref: vRef, reactive, computed, onMounted } = Vue;

    createApp({
        setup() {
            // --- State ---
            const view = vRef('month');
            const modalShow = vRef(false);
            const currentMonth = vRef(new Date(2026, 0, 1));
            const holidays = vRef({});
            const schedules = vRef({});
            const newEmployeeName = vRef('');
            const tempShiftType = vRef('morning');
            const selectedContext = reactive({ empId: null, date: null });

            const settings = reactive({
                employees: [],
                shifts: {
                    morning: { time: '07:00 - 15:00' },
                    middle: { time: '09:00 - 17:00' },
                    afternoon: { time: '15:00 - 23:00' },
                    off: { time: 'OFF' }
                }
            });

            // --- Computed ---
            const monthKey = computed(() => {
                const y = currentMonth.value.getFullYear();
                const m = (currentMonth.value.getMonth() + 1).toString().padStart(2, '0');
                return `${y}-${m}`;
            });

            const monthLabel = computed(() => {
                return currentMonth.value.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            });

            const monthCalendar = computed(() => {
                const y = currentMonth.value.getFullYear();
                const m = currentMonth.value.getMonth();
                const lastDay = new Date(y, m + 1, 0).getDate();
                const dates = [];
                for (let i = 1; i <= lastDay; i++) {
                    const d = new Date(y, m, i);
                    dates.push({
                        fullDate: `${y}-${(m+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`,
                        dateNum: i.toString().padStart(2,'0'),
                        dayName: d.toLocaleDateString('en-US', { weekday: 'short' })
                    });
                }
                return dates;
            });

            const weekCalendar = computed(() => {
                const now = new Date();
                const day = now.getDay();
                const diff = now.getDate() - (day === 0 ? 6 : day - 1);
                const mon = new Date(now.setDate(diff));
                const dates = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(mon);
                    d.setDate(mon.getDate() + i);
                    dates.push({
                        fullDate: `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`,
                        dateNum: d.getDate().toString().padStart(2,'0'),
                        dayName: d.toLocaleDateString('en-US', { weekday: 'short' })
                    });
                }
                return dates;
            });

            const activeCalendar = computed(() => view.value === 'week' ? weekCalendar.value : monthCalendar.value);

            // --- Methods ---
            const fetchHolidays = async () => {
                const year = currentMonth.value.getFullYear();
                try {
                    const response = await fetch(`https://api-harilibur.vercel.app/api?year=${year}`);
                    const data = await response.json();
                    const map = {};
                    data.forEach(h => { map[h.holiday_date] = h.holiday_name; });
                    holidays.value = map;
                } catch (e) { console.error("Holiday API Error", e); }
            };

            const isDateAllowed = (dateStr) => {
                let today = new Date(); today.setHours(0,0,0,0);
                let target = new Date(dateStr);
                let maxDate = new Date(); maxDate.setDate(today.getDate() + 30);
                return target >= today && target <= maxDate;
            };

            const getShift = (empId, date) => {
                const type = schedules.value?.[empId]?.[date]?.type;
                if (!type) return { type: 'none', time: '--' };
                return { type, time: settings.shifts[type]?.time || '--' };
            };

            const getShiftClass = (t) => {
                const base = "border-2 ";
                if (t === 'morning') return base + 'bg-emerald-50 text-emerald-700 border-emerald-100 hover:border-emerald-300';
                if (t === 'middle') return base + 'bg-sky-50 text-sky-700 border-sky-100 hover:border-sky-300';
                if (t === 'afternoon') return base + 'bg-orange-50 text-orange-700 border-orange-100 hover:border-orange-300';
                if (t === 'off') return base + 'bg-rose-50 text-rose-600 border-rose-100';
                return base + 'bg-slate-50 text-slate-400 border-slate-100';
            };

            const openModal = (empId, date) => {
                if (!isDateAllowed(date)) return alert("Date locked (30-day limit)");
                selectedContext.empId = empId;
                selectedContext.date = date;
                const current = getShift(empId, date).type;
                tempShiftType.value = current === 'none' ? 'morning' : current;
                modalShow.value = true;
            };

            const saveShiftUpdate = async () => {
                const path = `schedules/${monthKey.value}/${selectedContext.empId}/${selectedContext.date}`;
                await set(ref(db, path), { type: tempShiftType.value });
                modalShow.value = false;
            };

            const changeMonth = (n) => {
                const d = new Date(currentMonth.value);
                d.setMonth(d.getMonth() + n);
                currentMonth.value = d;
                fetchHolidays();
            };

            const addEmployee = async () => {
                if(!newEmployeeName.value) return;
                settings.employees.push({
                    id: Date.now().toString(),
                    name: newEmployeeName.value,
                    rotation: { odd: 'morning', even: 'afternoon' }
                });
                await saveSettings();
                newEmployeeName.value = '';
            };

            const removeEmployee = async (id) => {
                if(confirm('Delete employee?')) {
                    settings.employees = settings.employees.filter(e => e.id !== id);
                    await saveSettings();
                }
            };

            const saveSettings = () => set(ref(db, 'setting'), settings);

            const getWeekNumber = (dateStr) => {
                const d = new Date(dateStr);
                const firstDay = new Date(d.getFullYear(), d.getMonth(), 1);
                const adj = (firstDay.getDay() === 0) ? 6 : firstDay.getDay() - 1;
                return Math.ceil((d.getDate() + adj) / 7);
            };

            const applyRotation = async (empId) => {
                const emp = settings.employees.find(e => e.id === empId);
                const snapshot = await get(ref(db, `schedules/${monthKey.value}/${empId}`));
                const existing = snapshot.val() || {};
                const updates = {};
                let count = 0;

                monthCalendar.value.forEach(d => {
                    if (!existing[d.fullDate] && isDateAllowed(d.fullDate)) {
                        const weekNum = getWeekNumber(d.fullDate);
                        const type = (weekNum % 2 !== 0) ? emp.rotation.odd : emp.rotation.even;
                        updates[d.fullDate] = { type };
                        count++;
                    }
                });

                if (count > 0) {
                    await update(ref(db, `schedules/${monthKey.value}/${empId}`), updates);
                    alert(`Success: ${count} days rotation applied.`);
                } else {
                    alert('No empty slots in 30-day range.');
                }
            };

            // --- Lifecycle ---
            onMounted(() => {
                // Listen settings
                onValue(ref(db, 'setting'), (s) => {
                    if(s.exists()) {
                        const data = s.val();
                        settings.employees = data.employees || [];
                        settings.shifts = data.shifts;
                    }
                });

                // Listen schedules (global for easier month switching)
                onValue(ref(db, `schedules`), (s) => {
                    const allData = s.val() || {};
                    schedules.value = allData[monthKey.value] || {};
                });

                fetchHolidays();
            });

            // Watch month change to update local schedules ref
            createApp().version; // dummy for reactivity scope if needed, but onValue is sufficient.

            return {
                view, modalShow, currentMonth, holidays, schedules, settings, 
                newEmployeeName, tempShiftType, activeCalendar, monthLabel,
                changeMonth, openModal, getShift, getShiftClass, saveShiftUpdate,
                addEmployee, removeEmployee, saveSettings, applyRotation, isDateAllowed
            };
        }
    }).mount('#app');
</script>

</body>
</html>